<!DOCTYPE html>
<html lang="en">
	<style>
		.area-borders {
			fill: none;
			stroke: #fff;
			stroke-width: 0.5px;
		}

		.switch {
  			position: relative;
  			display: inline-block;
  			width: 32px;
  			height: 20px;
		}

		.switch input {
  			opacity: 0;
  			width: 0;
  			height: 0;
		}

		.slider {
  			position: absolute;
  			cursor: pointer;
  			top: 0;
 			left: 0;
  			right: 0;
  			bottom: 0;
  			background-color: #ccc;
  			-webkit-transition: .4s;
  			transition: .4s;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 12px;
			width: 12px;
			left: 4px;
			bottom: 4px;
			background-color: white;
			-webkit-transition: .4s;
			transition: .4s;
		}

		input:checked + .slider {
			background-color: #2196F3;
		}

		input:focus + .slider {
			box-shadow: 0 0 1px #2196F3;
		}

		input:checked + .slider:before {
			-webkit-transform: translateX(12px);
			-ms-transform: translateX(12px);
			transform: translateX(12px);
		}

		/* Rounded sliders */
		.slider.round {
			border-radius: 34px;
		}

		.slider.round:before {
			border-radius: 50%;
		}
	</style>
	<head>
		<meta charset="utf-8">
		<title>U.S. Map</title>
		<script type="text/javascript" src="d3.js"></script>
		<style type="text/css">
		</style>
	</head>
	<body>
		<h1 style="text-align:center">Our Title Here</h1>
		<div style="display:flex">
			<div style="justify-content: flex-start; border: black solid 1px; margin:20px;">
				<h2 style="text-align:center">United State of America</h2>
				<div id='mapHere'></div>
			</div>
			<div id='radio' style="justify-content: flex-end; border: black solid 1px; margin:20px; padding:10px">
				<h2 style="text-align:center">Data Options</h2>
				<label class="switch">
					<input id="stateCountyCheck" type="checkbox">
					<span class="slider round"></span>
					
				</label>
				<p>Counties instead of states (thats the slider above. will fix later)</p>
				<br>
				<input type="radio" name="dataType" value="Population" id='pop' checked>Population</input>
				<br>
				<input type="radio" name="dataType" value="2016_vote" id='vote2016'>3 Point Party Identification</input>
			</div>
		</div>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/topojson.v2.min.js"></script>
		<script type="text/javascript">
			//basic svg setup
			var width = 1000;
			var height = 600;
			var svg = d3.select("#mapHere").append("svg").attr("width", width).attr("height", height);
			var path = d3.geoPath();

			//distribution data var creation
			var popDist;
			var partyDist;

			//radio button setup
			var popradio = d3.select("#pop")
			popradio.on("change", radioUpdate)
			var vote2016radio = d3.select("#vote2016")
			vote2016radio.on("change", radioUpdate)

			//state county toggle
			var stateCountyCheckbox = d3.select("#stateCountyCheck")
			stateCountyCheckbox.on("change", stateCountyCheckboxUpdate)
			
			function filter(index, filterNames, filterValues){
				for(var i = 0; i < filterNames.length; i++){
					if (index[filterNames[i]] != filterValues[i]){
						return false;
					}
				}
				return true;
			}

			function getPopDist(poliData){
				var dist = new Array(57).fill(0);
				poliData.forEach(function(index){
					dist[parseInt(index.inputstate)] += 1;
				});
				return dist;
			}

			function getParty(poliData){
				var dist = new Array(57);
				for(var i = 0; i < dist.length; i++){
					dist[i] = new Array(8).fill(0);
				}
				poliData.forEach(function(index){
					if (index.pid3 != ""){
						var inputstate = parseInt(index.inputstate);
						var pid3 = parseInt(index.pid3)-1;
						dist[inputstate][pid3] += 1;
					}
				});
				return dist;
			}

			function maxParty(partyDist, d){
				var id = parseInt(d.id);
				var party = partyDist[id].indexOf(Math.max.apply(Math, partyDist[id]));
				var colors = [0,0,0];
				var value = partyDist[id][party];
				switch(party){
					case 0:
						return [0, 0, value];
					case 1:
						return [value, 0, 0];
					case 2:
						return [0, value, 0];
					case 3:
						return [value, 0, value];
					case 4:
						return [0, value, value];
					case 5:
						return [value, value, 0];
				}
				return colors;
			}

			function makeRandomColor(){
				return "rgb(" + Math.ceil(Math.random()*255) + "," + Math.ceil(Math.random()*255) + "," + Math.ceil(Math.random()*255) + ")"
			}

			function loadData(file, cb){
				d3.tsv(file, function(error,data){
					if (error) throw error;
					cb(data);
				});
			}

			function radioUpdate(){
				d3.selectAll("path").attr("fill", function(d){
					if(d){
						if(popradio.property("checked")){
							return "rgb(" + popDist[parseInt(d.id)]/10 + ",0," + popDist[parseInt(d.id)]/10 + ")"
						} else if(vote2016radio.property("checked")){
							var colors = maxParty(partyDist, d);
							return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
						}
					}
				})
			}

			function stateCountyCheckboxUpdate(){
				if(stateCountyCheckbox.property("checked")){
					loadCounties()
				} else {
					loadStates()
				}
			}

			function loadCounties(){
				svg.selectAll("*").remove()
				loadData('data/output.tsv', function(poliData){
				partyDist = getParty(poliData);
				d3.json("https://d3js.org/us-10m.v1.json", function(error, us) {
					if (error) throw error;
					popDist = getPopDist(poliData);
					svg.append("g")
						.attr("class", "counties")
						.selectAll("path")
						.data(topojson.feature(us, us.objects.counties).features)
						.enter().append("path")
						.attr("d", path)
						.attr("class", function(d){
							return d.id
						})
						.attr("fill", function(d){
							//need to make radio update work with counties
							return makeRandomColor()
						});

					svg.append("path")
						.attr("class", "area-borders")
						.attr("d", path(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; })));

					svg.select("g").selectAll("path")
						.on("click", function(){
							//change the current data here
							d3.select(this).attr("fill", makeRandomColor)
						})
				});
				});
			}

			function loadStates(){
				svg.selectAll("*").remove()
				loadData('data/output.tsv', function(poliData){
				partyDist = getParty(poliData);
				d3.json("https://d3js.org/us-10m.v1.json", function(error, us) {
					if (error) throw error;
					popDist = getPopDist(poliData);
					svg.append("g")
						.attr("class", "states")
						.selectAll("path")
						.data(topojson.feature(us, us.objects.states).features)
						.enter().append("path")
						.attr("d", path)
						.attr("class", function(d){
							return d.id
						})
						.attr("fill", function(d){
							//radioUpdate returns the colors based on what button is selected
							radioUpdate()
						});

					svg.append("path")
						.attr("class", "area-borders")
						.attr("d", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));

					svg.select("g").selectAll("path")
						.on("click", function(){
							//change the current data here
							d3.select(this).attr("fill", makeRandomColor)
						})
				});
				});
			}

			stateCountyCheckboxUpdate()
			
        </script>
    </body>
</html>
