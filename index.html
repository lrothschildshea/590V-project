<!DOCTYPE html>
<html lang="en">
	<style>
		.area-borders {
			fill: none;
			stroke: #fff;
			stroke-width: 0px;
		}

		.switch {
  			position: relative;
  			display: inline-block;
  			width: 32px;
  			height: 20px;
		}

		.switch input {
  			opacity: 0;
  			width: 0;
  			height: 0;
		}

		.slider {
  			position: absolute;
  			cursor: pointer;
  			top: 0;
 			left: 0;
  			right: 0;
  			bottom: 0;
  			background-color: #ccc;
  			-webkit-transition: .4s;
  			transition: .4s;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 12px;
			width: 12px;
			left: 4px;
			bottom: 4px;
			background-color: white;
			-webkit-transition: .4s;
			transition: .4s;
		}

		input:checked + .slider {
			background-color: #2196F3;
		}

		input:focus + .slider {
			box-shadow: 0 0 1px #2196F3;
		}

		input:checked + .slider:before {
			-webkit-transform: translateX(12px);
			-ms-transform: translateX(12px);
			transform: translateX(12px);
		}

		/* Rounded sliders */
		.slider.round {
			border-radius: 34px;
		}

		.slider.round:before {
			border-radius: 50%;
		}
	</style>
	<head>
		<meta charset="utf-8">
		<title>U.S. Map</title>
		<script type="text/javascript" src="d3.js"></script>
		<style type="text/css">
		</style>
	</head>
	<body style="background-color: rgb(253,253,253); margin:0px">
		<h1 style="text-align:center; color: white; font-size: 45px; background-color:#090C9B; margin:0px; padding:30px">Our Title Here</h1>
		<div style="display:flex; justify-content: space-evenly">
			<div style="border: #090C9B solid 2px; margin:20px; border-radius: 10px">
				<h2 style="text-align:center; background-color: #090C9B; color: white; margin: 0px; padding:20px; border-top-left-radius: 10px; border-top-right-radius: 10px">United State of America</h2>
				<div id='mapHere' style="background-color: white; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px"></div>
			</div>
			<div id='radio' style="border: #090C9B solid 2px; margin:20px; border-radius:10px">
				<h2 style="text-align:center; background-color: #090C9B; color: white; margin: 0px; margin-bottom:20px; padding:20px; border-top-left-radius: 10px; border-top-right-radius: 10px">Data Options</h2>
				<div style="padding-left:10px; padding-right:10px">
					<div style="display:flex; justify-content: space-evenly">
						<strong>
							<p style="margin:0px">States</p>
						</strong>
						<label class="switch">
							<input id="stateCountyCheck" type="checkbox">
							<span class="slider round"></span>
						</label>
						<strong>
							<p style="margin:0px">Counties</p>
						</strong>
					</div>
					<br>
					<input type="radio" name="dataType" value="Population" id='pop' checked>Population</input>
					<br>
					<input type="radio" name="dataType" value="pid_3" id='pid3'>3 Point Party Identification</input>
					<br>
					<input type="radio" name="dataType" value="2016_vote" id='vote2016'>2016 Predisential Election Results</input>
					<br>
					<input type="radio" name="dataType" value="2012_vote" id='vote2012'>2012 Predisential Election Results</input>
					<br>
					<h3 style="text-align:center">Filters</h3>
					<br>
					Gender
					<br>
					<input type="checkbox" class="gender" value="1" id="male">Male</input>
					<input type="checkbox" class="gender" value="2" id="female">Female</input>
					<br>
					Clause
					<br>
					<input type="radio" name="clause" value="AND" id="and" checked>AND</input>
					<input type="radio" name="clause" value="OR" id="or">OR</input>
					<br>
					<button type="button" id="clrButton">Clear Selection</button>
					<button type="button" id="clrFilter">Clear Filters</button>
					<br>
				</div>
			</div>
		</div>
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://d3js.org/topojson.v2.min.js"></script>
		<script type="text/javascript">
			//basic svg setup
			var width = 1000;
			var height = 600;
			var path = d3.geoPath();
			var selected = new Map();
			const selectedColor = "#aaaaaa"
			const selectedWidth = "2px"
			const unselectedColor = "#fff"
			const unselectedWidth = "0px"

			const zoom = d3.zoom()
				.scaleExtent([1, 5])
				.translateExtent([[0,0], [width, height]])
				.extent([[0, 0], [width, height]])
				.on("zoom", zoomed);

			var svg = d3.select("#mapHere").append("svg").attr("width", width).attr("height", height).call(zoom);

			//distribution data var creation
			var popDist;
			var partyDist;
			var vote2016;
			var vote2012;
			var popDistCounty;
			var partyDistCounty;
			var vote2016County;
			var vote2012County;
			var filterID = new Array();
			var filterValues = new Array();
			var filterClass = new Array();
			var statesBool = true;
			var filterLength = 0;
			var filterClause = 'AND';

			var maxPartyCty = new Map()
			var max2016VtCty = new Map()
			var max2012VtCty = new Map()

			//clear button
			d3.select("#clrButton").on("click", clrButtonClick)
			d3.select("#clrFilter").on("click", clrFilterClick)

			//radio button setup
			var popradio = d3.select("#pop")
			popradio.on("change", function(){
				renderMap()
			})
			var pid3radio = d3.select("#pid3")
			pid3radio.on("change", function(){
				renderMap()
			})
			var vote2016radio = d3.select('#vote2016')
			vote2016radio.on("change", function(){
				renderMap()
			})
			var vote2012radio = d3.select('#vote2012')
			vote2012radio.on("change", function(){
				renderMap()
			})

			var maleFilter = d3.select("#male")
			maleFilter.on("change", function(){
				if (filterClause == 'AND'){
					var boxes = document.getElementsByClassName('gender');
					for(var i = 0; i < boxes.length; i++){
						if(boxes[i].id != "male"){
							if(boxes[i].checked == true){
								boxes[i].checked = false;
								filterValues.splice(filterID.indexOf(boxes[i].id), 1);
								filterClass.splice(filterID.indexOf(boxes[i].id), 1);
								filterID.splice(filterID.indexOf(boxes[i].id), 1);
								filterLength = -1
							}
						}
					}
				}
				filterData(this);
			});
			var femaleFilter = d3.select('#female')
			femaleFilter.on("change",function(){
				if (filterClause == 'AND'){
					var boxes = document.getElementsByClassName('gender');
					for(var i = 0; i < boxes.length; i++){
						if(boxes[i].id != "female"){
							if(boxes[i].checked == true){
								boxes[i].checked = false;
								filterValues.splice(filterID.indexOf(boxes[i].id), 1);
								filterClass.splice(filterID.indexOf(boxes[i].id), 1);
								filterID.splice(filterID.indexOf(boxes[i].id), 1);
								filterLength = -1
							}
						}
						
					}
				}
				filterData(this);
			});
			var andradio = d3.select('#and');
			andradio.on("change", function(){
				loadAreas(statesBool);
			});
			var orradio = d3.select('#or');
			orradio.on("change", function(){
				loadAreas(statesBool);
			});

			//state county toggle
			var stateCountyCheckbox = d3.select("#stateCountyCheck")
			stateCountyCheckbox.on("change", function(){
				renderMap()
			})

			//this is the line that actually draws the map. all vars and stuff should be above it. only functions should be below it.
			renderMap()
			
			function zoomed(){
				d3.select("g").attr("transform", d3.event.transform);
			}

			function clrButtonClick(){
				selected = new Map()
				renderMap()
			}

			function clrFilterClick(){
				for(var i = 0; i < filterID.length; i++){
					document.getElementById(filterID[i]).checked = false
				}
				filterID = new Array();
				filterValues = new Array();
				filterClass = new Array();
				loadAreas(statesBool);
			}
			
			function filter(index){
				if(filterClause == 'AND'){
					for(var i = 0; i < filterClass.length; i++){
						if (index[filterClass[i]] != filterValues[i]){
							return false;
						}
					}
					return true;
				}
				else{
					if(filterClass.length == 0){
						return true;
					}
					for(var i = 0; i < filterClass.length; i++){
						if (index[filterClass[i]] == filterValues[i]){
							return true;
						}
					}
					return false;

				}
			}

			function filterData(obj){
				if(document.getElementById(obj.id).checked == true){
					filterClass.push(obj.className);
					filterID.push(obj.id);
					filterValues.push(obj.value);
				}else{
					filterValues.splice(filterID.indexOf(obj.id), 1);
					filterClass.splice(filterID.indexOf(obj.id), 1);
					filterID.splice(filterID.indexOf(obj.id), 1);
				}
				loadAreas(statesBool);
			}

			function getPopDist(poliData){
				var dist = new Array(57).fill(0);
				poliData.forEach(function(index){
					if(filter(index)){
						dist[parseInt(index.inputstate)] += 1;
					}
				});
				return dist;
			}

			function getPopDistCounty(poliData){
				let dist = new Object();
				poliData.forEach(function(index){
					if (filter(index)){	
						let county = parseInt(index.countyfips);
						if(county){
							if(!(dist[county])){
								dist[county] = 0;
							}
							dist[county] += 1;
						}
					}
				});
				return dist;
			}

			function getParty(poliData){
				let dist = new Array(57);
				for(var i = 0; i < dist.length; i++){
					dist[i] = new Array(8).fill(0);
				}
				poliData.forEach(function(index){
					if (filter(index)){
						if (index.pid3 != ""){
							let inputstate = parseInt(index.inputstate);
							let pid3 = parseInt(index.pid3)-1;
							dist[inputstate][pid3] += 1;
						}
					}
					
				});
				return dist;
			}

			function getPartyCounty(poliData){
				let dist = new Object();
				poliData.forEach(function(index){
					if (filter(index)){
						if(index.pid3 != ""){
							let county = parseInt(index.countyfips);
							if(!(dist[county])){
								dist[county] = new Array(8).fill(0);
							}
							let pid3 = parseInt(index.pid3)-1;
							dist[county][pid3] += 1;
						}
					}
				});
				return dist;
			}

			function maxParty(partyDist, d){
				var id = parseInt(d.id);
				var party = partyDist[id].indexOf(Math.max.apply(Math, partyDist[id]));
				var colors = [0,0,0];
				var value = (partyDist[id][party]/popDist[id]) * 255;
				switch(party){
					case 0:
						return [0, 0, value];
					case 1:
						return [value, 0, 0];
					case 2:
						return [0, value, 0];
					case 3:
						return [value, 0, value];
					case 4:
						return [0, value, value];
					case 5:
						return [value, value, 0];
				}
				return colors;
			}

			function maxPartyCounty(partyDistCounty, d){
				var id = parseInt(d.countyfips);
				if(partyDistCounty[id]){
					
					var party = partyDistCounty[id].indexOf(Math.max.apply(Math, partyDistCounty[id]));
					var value = (partyDistCounty[id][party]/popDistCounty[id]) * 255;
					switch(party){
						case 0:
							return "rgb(0,0," + value + ")";
						case 1:
							return "rgb(" + value + ",0,0)";
						case 2:
							return "rgb(0," + value + ",0)";
						case 3:
							return "rgb(" + value + ",0," + value + ")";
						case 4:
							return "rgb(0," + value + "," + value + ")";
						case 5:
							return "rgb(" + value + "," + value + ",0)";
					}
				}
				return "rgb(0,0,0)";
			}

			function getVote2016(poliData){
				var dist = new Array(57);
				for(var i=0; i < dist.length; i++){
					dist[i] = new Array(8).fill(0);
				}
				poliData.forEach(function(index){
					if (filter(index)){
						var inputstate = parseInt(index.inputstate);
						var pres = parseInt(index.CC16_410a)-1;
						if(pres<7){
							dist[inputstate][pres] += 1;
						}
					}
				});
				return dist;
			}

			function getVote2016County(poliData){
				let dist = new Object();
				poliData.forEach(function(index){
					if (filter(index)){
						var county = parseInt(index.countyfips);
						if(!(dist[county])){
							dist[county] = new Array(8).fill(0);
						}
						var pres = parseInt(index.CC16_410a)-1;
						if(pres < 7){
							dist[county][pres] += 1;
						}
					}
				});
				return dist;
			}

			function maxVote2016(vote2016, d){
				var id = parseInt(d.id);
				var pres = vote2016[id].indexOf(Math.max.apply(Math, vote2016[id]));
				var colors = [0,0,0];
				var value = (vote2016[id][pres]/popDist[id])*255;
				switch(pres){
					case 0:
						return [value, 0, 0];
					case 1:
						return [0, 0, value];
					case 2:
						return [0,value,value];
					case 3:
						return [0,value,0];
					case 7:
						return [value, value, 0];
				}
				return colors;
			}

			function maxVote2016County(vote2016County, d){
				var id = parseInt(d.countyfips);
				var colors = [0,0,0];
				if(vote2016County[id]){
					var pres = vote2016County[id].indexOf(Math.max.apply(Math, vote2016County[id]));
					var value = (vote2016County[id][pres]/popDistCounty[id])*255;
					switch(pres){
						case 0:
							return "rgb(" + value + ",0,0)";
						case 1:
							return "rgb(0,0," + value + ")";
						case 2:
							return "rgb(0," + value + "," + value + ")";
						case 3:
							return "rgb(0," + value + ",0)";
						case 7:
							return "rgb(" + value + "," + value + ",0)";
					}
				}
				return colors;
			}

			function getVote2012(poliData){
				var dist = new Array(57);
				for(var i=0; i < dist.length; i++){
					dist[i] = new Array(3).fill(0);
				}
				poliData.forEach(function(index){
					if (filter(index)){
						var inputstate = parseInt(index.inputstate);
						var pres = parseInt(index.CC16_326)-1;
						if(pres < 3){
							dist[inputstate][pres] += 1;
						}
					}
				});
				return dist;
			}

			function getVote2012County(poliData){
				let dist = new Object();
				poliData.forEach(function(index){
					if (filter(index)){
						var county = parseInt(index.countyfips);
						if(!(dist[county])){
							dist[county] = new Array(8).fill(0);
						}
						var pres = parseInt(index.CC16_326)-1;
						if(pres < 3){
							dist[county][pres] += 1;
						}
					}
				});
				return dist;
			}

			function maxVote2012(vote2012, d){
				var id = parseInt(d.id);
				var pres = vote2012[id].indexOf(Math.max.apply(Math, vote2012[id]));
				var colors = [0,0,0];
				var value = (vote2012[id][pres]/popDist[id])*255;
				switch(pres){
					case 0:
						return [0, 0, value];
					case 1:
						return [value, 0, 0];
					case 2:
						return [0,value,0];
				}
				return colors;
			}

			function highlightSelectedArea(element){
				if(selected.get(d3.select(element).attr("class")) === "undefined"){
					selected.set(d3.select(element).attr("class"), true)
				} else {
					selected.set(d3.select(element).attr("class"), !selected.get(d3.select(element).attr("class")))
				}

				if(selected.get(d3.select(element).attr("class"))){
					d3.select(element).attr("stroke", selectedColor).attr("stroke-width", selectedWidth)
				} else {
					d3.select(element).attr("stroke", unselectedColor).attr("stroke-width", unselectedWidth)
				}
			}
			
			function maxVote2012County(vote2012County, d){
				var id = parseInt(d.countyfips);
				var colors = [0,0,0];
				if(vote2012County[id]){
					var pres = vote2012County[id].indexOf(Math.max.apply(Math, vote2012County[id]));
					var value = (vote2012County[id][pres]/popDistCounty[id])*255;
					switch(pres){
						case 0:
							return [0, 0, value];
						case 1:
							return [value, 0, 0];
						case 2:
							return [0,value,0];
					}
				}
				return colors;
			}

			function makeRandomColor(){
				return "rgb(" + Math.ceil(Math.random()*255) + "," + Math.ceil(Math.random()*255) + "," + Math.ceil(Math.random()*255) + ")"
			}

			function loadData(file, cb){
				d3.tsv(file, function(error,data){
					if (error) throw error;
					cb(data);
				});
			}

			function radioUpdate(d){
				if(d){
					if(popradio.property("checked") && !(stateCountyCheckbox.property("checked"))){
						var total = 0;
						for(var i=0; i < popDist.length; i++){
							total += popDist[i];
						}
						total = total/10000
						return "rgb(" + popDist[parseInt(d.id)]/total + ",0," + popDist[parseInt(d.id)]/total + ")"
					} else if(pid3radio.property("checked")  && !(stateCountyCheckbox.property("checked"))){
						var colors = maxParty(partyDist, d);
						return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
					} else if(vote2016radio.property("checked") && !(stateCountyCheckbox.property("checked"))){
						var colors = maxVote2016(vote2016, d);
						return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
					} else if(vote2012radio.property("checked") && !(stateCountyCheckbox.property("checked"))){
						var colors = maxVote2012(vote2012, d);
						return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
					}else if(popradio.property("checked") && stateCountyCheckbox.property("checked")){
						let id = parseInt(d.id);
						let value = 0;
						if(popDistCounty[id]){
							value = popDistCounty[id]*10;
						}
						return "rgb(" + value + ",0," + value + ")"
					}else if(pid3radio.property("checked")  && stateCountyCheckbox.property("checked")){
						if(!maxPartyCty.get(parseInt(d.id))){
							return "rgb(0,0,0)"
						}
						return maxPartyCty.get(parseInt(d.id));
					}else if(vote2016radio.property("checked") && stateCountyCheckbox.property("checked")){
						if(!max2016VtCty.get(parseInt(d.id))){
							return "rgb(0,0,0)"
						}
						return max2016VtCty.get(parseInt(d.id))
					}else if(vote2012radio.property("checked") && stateCountyCheckbox.property("checked")){
						if(!max2012VtCty.get(parseInt(d.id))){
							return "rgb(0,0,0)"
						}
						var colors = max2012VtCty.get(parseInt(d.id))
						return "rgb(" + colors[0] + "," + colors[1] + "," + colors[2] + ")";
					}
				}

			}

			function renderMap(){
				if(stateCountyCheckbox.property("checked")){
					statesBool = false;
				} else {
					statesBool = true;
				}
				loadAreas(statesBool);
			}

			function loadAreas(statesBool){
				loadData('data/output.tsv', function(poliData){
				if(popDistCounty === undefined || filterLength != filterClass.length || (filterClause == 'AND' && document.getElementById('and').checked == false) || (filterClause == 'OR' && document.getElementById('or').checked == false)){
					if(document.getElementById('and').checked == true){
						filterClause = 'AND';
					} else {
						filterClause = 'OR';
					}
					filterLength = filterClass.length;
					popDist = getPopDist(poliData);
					popDistCounty = getPopDistCounty(poliData);
					partyDistCounty = getPartyCounty(poliData);
					vote2016County = getVote2016County(poliData);
					vote2012County = getVote2012County(poliData);
					partyDist = getParty(poliData);
					vote2016 = getVote2016(poliData);
					vote2012 = getVote2012(poliData);
					poliData.forEach(function(d){
						maxPartyCty.set(parseInt(d.countyfips), maxPartyCounty(partyDistCounty, d))
						max2016VtCty.set(parseInt(d.countyfips), maxVote2016County(vote2016County, d))
						max2012VtCty.set(parseInt(d.countyfips), maxVote2012County(vote2012County, d))
					});
				}
				d3.json("https://d3js.org/us-10m.v1.json", function(error, us) {
					if (error) throw error;
					svg.selectAll("g").remove()
					svg.selectAll("path").remove()
					if(statesBool){
						svg.append("g")
						.attr("class", "states")
						.selectAll("path")
						.data(topojson.feature(us, us.objects.states).features)
						.enter().append("path")
						.attr("d", path)
						.attr("class", function(d){
							return d.id
						}).attr("fill", function(d){
							return radioUpdate(d)
						})
					} else {
						svg.append("g")
						.attr("class", "counties")
						.selectAll("path")
						.data(topojson.feature(us, us.objects.counties).features)
						.enter().append("path")
						.attr("d", path)
						.attr("class", function(d){
							return d.id
						}).attr("fill", function(d){
							return radioUpdate(d)
						})
					}

					svg.selectAll("path")
						.attr("stroke", function(){
							if(selected.get(d3.select(this).attr("class"))){
								return selectedColor
							} else {
								return unselectedColor
							}
						}).attr("stroke-width", function(){
							if(selected.get(d3.select(this).attr("class"))){
								return selectedWidth
							} else {
								return unselectedWidth
							}
						}).on("click", function(){
							highlightSelectedArea(this)
						});

					svg.append("path")
						.attr("class", "area-borders")
						.attr("d", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));
				});
				});
			}
        </script>
    </body>
</html>
